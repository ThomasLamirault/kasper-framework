<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Kasper Auto Documentation</title>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <link rel="shortcut icon" href="public/assets/ico/favicon.ico">
    <!-- Bootstrap core CSS -->
    <link href="public/css/bootstrap.min.css" rel="stylesheet">
    <!-- JQuery UI -->
    <link href="public/css/jquery-ui-1.10.4.custom.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="public/css/custom-theme.css" rel="stylesheet">

    <!-- Just for debugging purposes. Don't actually copy this line! -->
    <!--[if lt IE 9]><script src="../../assets/js/ie8-responsive-file-warning.js"></script><![endif]-->

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <script src="app/js/handlebars.js"></script>
    <script src="app/js/jquery.searchable.js"></script>
    <script src="app/js/jquery-ui-1.10.4.custom.min.js"></script>
    <script>
      $.fn.exists = function () {
        console.log(">" + this, this);
        return this.length !== 0;
      }
    </script>
    <script>
      Handlebars.registerHelper('ifCond', function (value1, value2, options) {
        if(value1 === value2) {
          return options.fn(this);
        }
        return options.inverse(this);
      });
    </script>
    <script>

        var DOMAIN_TEMPLATE_KEY = "domain-template-key";
        var COMPONENT_TEMPLATE_KEY = "component-template-key";
        var SIDE_BAR_TEMPLATE_KEY = "sidebar-template-key";
        var PANEL_CONTENT_TEMPLATE_KEY = "component-panel-content-template-key";        
        var PANEL_TEMPLATE_KEY = "component-panel-template-key";      

        var cache_templates = {};
        var nodes = {};
        var component_urls_per_domain = {};

        /* Search */
        function initializeHomeSearch() {
          console.log("initialize home search!");

          $( '#searchable-domain-box' ).searchable({
            searchField: '#search-domain-box',
            selector: '.domain-box',
            childSelector: '.domain-box-selector',
            show: function( elem ) {
                elem.slideDown(100);
            },
            hide: function( elem ) {
                elem.slideUp( 100 );
            }
          });
        }

        function initializeGlobalSearch(data) {
          console.log("initialize global search!");

          $( "#search" ).autocomplete({
              source: data,
              select: function( event, ui ) {
                $("#search").val(ui.item.label);
                $("#search_type").val(ui.item.type);
                $("#search_domain").val(ui.item.domain);
                return false;
              }
            }).data( "ui-autocomplete" )._renderItem = function( ul, item ) {
              /* ensure to be on the navigation bar*/
              ul.css("z-index", "2000");
              ul.id = "search-autocomplete";
              var type = '';
              if(item.type == "domain") {
                type = '<span class="glyphicon glyphicon-unchecked"></span>';
              } else if(item.type == "command"){
                type = '<span class="glyphicon glyphicon-log-in"></span>';
              } else if(item.type == "query"){
                type = '<span class="glyphicon glyphicon-log-out"></span>';
              } else if(item.type == "event"){
                type = '<span class="glyphicon glyphicon-new-window"></span>';
              } else if(item.type == "concept"){
                type = '<span class="glyphicon glyphicon-stop"></span>';
              } else if(item.type == "relation"){
                type = '<span class="glyphicon glyphicon-stop"></span>';
              }
              return $( "<li>" )
                .append( '<a>' + type + item.label + '</a>' )
                .appendTo( ul );
            };

            $("#search").keyup(function (e) {
              if (e.keyCode == 13) {
                // Do something
                var type = $("#search_type").get(0).value;
                var domain = $("#search_domain").get(0).value;

                console.log("search", type, this.value, domain);

                if(type != "domain") {
                  go_dyn(nodes[domain], "component-" + this.value);
                } else {
                  go_dyn(nodes[domain]);
                }
              }
            });

        }
        /* Search End */

        /* Nav */
        function go_home() {
          console.log("go home!");

          $("#contents > div").hide();
          $(".nav > li").removeClass("active")
          $("#contents_home").show();
          $("#home").parent().addClass("active")
        }

        function go_about() {
          console.log("go about!");

          $("#contents > div").hide();
          $(".nav > li").removeClass("active")
          $("#contents_about").fadeIn("slow");
          $("#about").parent().addClass("active")
        }

        function go_contact() {
          console.log("go contact!");

          $("#contents > div").hide();
          $(".nav > li").removeClass("active")
          $("#contents_contact").fadeIn("slow");
          $("#contact").parent().addClass("active")
        }

        function go_dyn(domain, hash) {
          console.log("go dyn", domain.name);

          $("#contents_dyn").empty();
          $(".nav > li").removeClass("active")

          $("#contents_dyn").append('<div id="wrapper_contents_dyn" class="col-md-9" role="main"></div>');
          $("#contents_dyn").append('<div id="sidebar_contents_dyn" class="col-md-3" role="main"></div>');

          $("#wrapper_contents_dyn").append(cache_templates[DOMAIN_TEMPLATE_KEY]({ node: domain }));
          $("#wrapper_contents_dyn").append('<div id="commands-container" class="row"></div>');
          $("#wrapper_contents_dyn").append('<div id="queries-container" class="row"></div>');
          $("#wrapper_contents_dyn").append('<div id="events-container" class="row"></div>');
          $("#wrapper_contents_dyn").append('<div id="domain-container" class="row"></div>');

          $("#sidebar_contents_dyn").append(cache_templates[SIDE_BAR_TEMPLATE_KEY]({ node: domain }));
          
          function PanelContent(url, init) {
            this.url = url;
            this.init = init;
          }

          function appendDomainComponent(data) {
            if( $("#domain-container .panel").length == 0 ) {
                $("#domain-container").append(cache_templates[PANEL_TEMPLATE_KEY]( {title: "Domain"} ));
              }
              $("#domain-container .list-group").append(cache_templates[PANEL_CONTENT_TEMPLATE_KEY]( { data: data} ));
          }

          var panel_contents = [
            new PanelContent("http://localhost:9988/kasper/doc/domain/" + domain.name + "/commands", function(data) {
              $("#commands-container").append(cache_templates[COMPONENT_TEMPLATE_KEY]( { title: "Commands", data: data} ));
            }),
            new PanelContent("http://localhost:9988/kasper/doc/domain/" + domain.name + "/queries", function(data) {
              $("#queries-container").append(cache_templates[COMPONENT_TEMPLATE_KEY]( { title: "Queries", data: data} ));
            }),
            new PanelContent("http://localhost:9988/kasper/doc/domain/" + domain.name + "/events", function(data) {
              $("#events-container").append(cache_templates[COMPONENT_TEMPLATE_KEY]( { title: "Events", data: data} ));
            }),
            new PanelContent("http://localhost:9988/kasper/doc/domain/" + domain.name + "/concepts", function(data) {
              appendDomainComponent(data);
            }),
            new PanelContent("http://localhost:9988/kasper/doc/domain/" + domain.name + "/relations", function(data) {
              appendDomainComponent(data);
            })
          ];

          var actualLoad = 0;
          var f = function() { if(hash) { scrollToAnchor(hash, -60); } };

          panel_contents.forEach(function(panel_content) {
            $.get(panel_content.url)
              .done(function(data) {
                panel_content.init(data);
                execute(panel_contents.length, ++actualLoad, f);
              });
          });

          $("#contents > div").hide();
          $("#contents_dyn").fadeIn("slow");
          
          $("#home-from-" + domain.name).click(function() {
            go_home();
          })

          initialize_content_dyn_nav();
        }

        function execute(expected, actual, f) {
          if(expected == actual) {
            f();
          }
        }

        function scrollToAnchor(hash, offset){
          var new_position = $('#'+hash).offset();
          var new_top_position = new_position.top + offset;
          console.log("scroll to : " + hash + " at " + new_top_position);

          window.scrollTo(new_position.left, new_top_position);
        }

        function initialize_nav() {
          console.log("initialize navigation!");

          $("#contents > div").hide();
          $("#contents_home").show();

          $('#home, .home, #brand').click(function() {
            go_home();
          })

          $('#about').click(function() {
            go_about();
          })

          $('#contact').click(function() {
            go_contact();
          })
        }

        function initialize_content_dyn_nav() {

          $('.sidebar-contents-dyn a').click(function(event) {
            if( $(this).parent().hasClass("component-category") ) {
              event.preventDefault();

              $(".component-category").removeClass("active");

              $(this).parent().addClass("active");

              var anchor = $(this).attr("href");
              scrollToAnchor(anchor.substring(1, anchor.length), -65);

            } else if( $(this).parent().hasClass("component-item") ) {
              event.preventDefault();

              $(".component-item").removeClass("active");

              $(this).parent().addClass("active");

              var anchor = $(this).attr("href");
              scrollToAnchor(anchor.substring(1, anchor.length), -65);

            } else {
              $(".component-category").removeClass("active");
            }
          });
        }
        /* Nav End */

        /* Data */
        function get_search_raw(type, label, domain) {
          return {
            "type":type,
            "label":label,
            "domain":domain
          };
        }

        function compute_search_data(domain) {
          var data = [];

          data.push(get_search_raw("domain", domain.label, domain.name));

          $.each(domain.commands, function(n, command) {
            data.push(get_search_raw("command", command.label, domain.name));
          });

          $.each(domain.queries, function(n, query) {
            data.push(get_search_raw("query", query.label, domain.name));
          });

          $.each(domain.events, function(n, c_event) {
            data.push(get_search_raw("event", c_event.label, domain.name));
          });

          $.each(domain.concepts, function(n, concept) {
            data.push(get_search_raw("concept", concept.label, domain.name));
          });

          $.each(domain.relations, function(n, relation) {
            data.push(get_search_raw("relation", relation.label, domain.name));
          });

          return data;
        }

        function get_url_per_components(domain) {
          var url_per_components = {};

          $.each(domain.commands, function(n, command) {
            url_per_components[command.name] = command.url;
          });

          $.each(domain.queries, function(n, query) {
            url_per_components[query.name] = query.url;
          });

          $.each(domain.events, function(n, event) {
            url_per_components[event.name] = event.url;
          });

          return url_per_components;
        }

        function load_home_page(template) {
          $.get("http://localhost:9988/kasper/doc/domains")
            .done(function(data) {

              if (data.list) {
                var searchData = [];

                /* Populate the home page */
                $.each(data.list, function(n, domain) {

                  /* Retrieve search data */
                  searchData = searchData.concat(compute_search_data(domain));

                  /* Reference node*/
                  component_urls_per_domain[domain.name] = get_url_per_components(domain);
                  nodes[domain.name] = domain;

                  $("#contents_home .page").append(template({ node: domain }))
                  
                  $("#domain-" + domain.name + "-btn").click(function(){
                    go_dyn(domain);
                  });

                  if(n == data.list.length - 1) {
                    initializeHomeSearch();  
                    initializeGlobalSearch(searchData);
                  }
                });
              }
            })
            .fail(function() {
              console.log("failed to load data from '/kasper/doc/domains'");
            });         
        }

        $(document).ready(function() {
            initialize_nav();

            /* Load templates */
            function Template(name, url, initializedFunction) {
              this.name = name;
              this.url = url;
              this.initialized = function(source) {
                console.log("initialized template ", this);
                if(initializedFunction) {
                  initializedFunction(source);
                }
              }
            }

            var template_descritors = [ 
              new Template(SIDE_BAR_TEMPLATE_KEY, "app/templates/sidebar.hbars"),
              new Template(DOMAIN_TEMPLATE_KEY, "app/templates/domain-card.hbars"),
              new Template(COMPONENT_TEMPLATE_KEY, "app/templates/component-card.hbars"),
              new Template(PANEL_CONTENT_TEMPLATE_KEY, "app/templates/component-panel-content.hbars"),
              new Template(PANEL_TEMPLATE_KEY, "app/templates/component-panel.hbars"),
              new Template(DOMAIN_TEMPLATE_KEY, "app/templates/domain-card.hbars"),
              new Template("domain-box-key", "app/templates/domain-box.hbars", function(template) {
                load_home_page(template);
              })
            ];

            template_descritors.forEach(function(template_descritor) {
              $.get(template_descritor.url)
                .done( function(source) {
                  var template= Handlebars.compile(source);
                  template_descritor.initialized(template);
                  cache_templates[template_descritor.name] = template;
                })
                .fail(function() {
                  console.log("failed to load template '" + template_descritor.url + "'");
                });
            });           
        });
        /* Data End*/

    </script>
  </head>

  <body>

    <!-- Fixed navbar -->
    <header class="navbar navbar-default navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a id="brand" class="navbar-brand" href="#">autodoc</a>
        </div>

        <div class="navbar-collapse collapse">

          <div id="search-container" class="nav navbar-nav navbar-right col-md-4">
            <div class="input-group">
              <span class="input-group-addon"><span class="glyphicon glyphicon-search"></span></span>
              <input id="search" class="form-control"/>
              <input id="search_type" type="hidden"/>
              <input id="search_domain" type="hidden"/>
            </div>
          </div>

          <ul class="nav navbar-nav navbar-left">
            <li class="active"><a id="home" href="#">Home</a></li>
            <li><a id="about" href="#about">About</a></li>
            <li><a id="contact" href="#contact">Contact</a></li>
          </ul>
          
        </div>
      </div>
    </header>

    <div class="main-container">
      <div id="contents">

        <!-- Home page-->
        <div id="contents_home" class="hero-unit">
          <div class="container">
            <ol class="breadcrumb">
              <li class="active">Home</li>
            </ol>
          </div>

          <div class="container panel">
            <div class="input-group panel-body">
              <span class="input-group-addon"><span class="glyphicon glyphicon-filter"></span></span>
              <input class="form-control" id="search-domain-box" type="text" placeholder=""/>
            </div>

            <div class="container page" id="searchable-domain-box">
              <div class="domain-box"></div>
            </div>

          </div>          
        </div>

        <!-- About page -->
        <div id="contents_about" class="hero-unit">
          <div class="container">
            <ol class="breadcrumb">
              <li><a class="home" href="#home">Home</a></li>
              <li class="active">About</li>
            </ol>
          </div>
          <div class="container page">
            <div class="panel panel-default">
              <h2 class="panel-heading"><span class="glyphicon glyphicon-align-justify"></span>About</h2>
              <div class="panel-body">
                ...
              </div>
            </div>
          </div>
        </div>

        <!-- Contact page -->
        <div id="contents_contact" class="hero-unit">
          <div class="container">
            <ol class="breadcrumb">
              <li><a class="home" href="#home">Home</a></li>
              <li class="active">Contact</li>
            </ol>
          </div>
          <div class="container page">
            <div class="panel panel-default">
              <h2 class="panel-heading"><span class="glyphicon glyphicon-envelope"></span>Contact</h2>
              <div class="panel-body">
                About general Kasper purposes : Viadeo architecture team &lt;<a href="mailto: architecture@viadeoteam.com">architecture@viadeoteam.com</a>&gt;
              </div>
            </div>
          </div>
        </div>

        <!-- Dynamic page -->
        <div id="contents_dyn" class="hero-unit container">
        </div>

      </div>
    </div>

    <footer class="navbar-default">
      <div class="container">
        <ul class="list-unstyled list-inline text-center">
          <li><a href="https://github.com/viadeo/kasper-framework">GitHub</a></li>
          <li>·</li>
          <li><a href="https://github.com/viadeo/kasper-framework/issues?state=open">Issues</a></li>
          <li>·</li>
          <li><a href="https://github.com/viadeo/kasper-framework/releases">Releases</a></li>
          <li>·</li>
          <li><a href="https://github.com/viadeo/kasper-framework/blob/master/CHANGES.md">Changes</a></li>
        </ul>
      </div>
    </footer>
    
  </body>
</html>